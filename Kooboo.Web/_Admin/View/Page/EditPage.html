<!-- #layout name=default -->
<div id="main" class="fixed">
  <div class="heander-panel">
    <div class="page-header">
      <template v-if="isNewPage">
        <h1 class="title pull-left">{{Kooboo.text.common.Page + ': '}}</h1>
        <div class="form-group pull-left">
          <input
            type="text"
            placeholder="name"
            class="input-large form-control"
            v-model="name"
          />
        </div>
      </template>
      <h1 v-else class="title pull-left"
        ><span>{{ Kooboo.text.common.Page + ': '}}</span
        ><strong :title="name">{{name}}</strong></h1
      >
      <kb-multilang-selector
        v-if="multiLangs"
        v-show="curType == 'preview'"
        :cultures="multiLangs.cultures"
        :default-culture="multiLangs.default"
      ></kb-multilang-selector>
      <button
        v-show="pageContent && curType == 'code'"
        @click="formatCode"
        type="button"
        class="btn btn-default pull-right"
        >Format code</button
      >
    </div>
  </div>
  <div class="block-fullpage with-buttons">
    <div class="block-visual-editor default">
      <div class="tabs-bottom">
        <div class="tab-content">
          <section class="tab-pane" :class="{ 'active': curType == 'preview' }">
            <div class="kb-editor">
              <iframe
                src="about:blank"
                id="page_iframe"
                class="kb-iframe"
              ></iframe>
            </div>
            <div class="kb-panel">
              <ul class="nav nav-tabs">
                <li class="active">
                  <a href="#page_setting" data-toggle="tab">Settings</a>
                </li>
              </ul>
              <div class="tab-content">
                <section class="active" id="page_setting" class="tab-pane">
                  <div class="panel-group">
                    <kb-page-basic-settings
                      v-if="settings&&multiLangs"
                      :settings="settings"
                      :multi-langs="multiLangs"
                    >
                    </kb-page-basic-settings>
                    <kb-page-html-meta
                      v-if="settings&&multiLangs"
                      :settings="settings"
                      default-lang="multiLangs.default"
                    >
                    </kb-page-html-meta>

                    <kb-page-parameters
                      v-if="settings"
                      :parameters="settings.parameters"
                    >
                    </kb-page-parameters>
                    <div>
                      <div class="panel panel-default">
                        <div
                          class="panel-heading clickable"
                          data-toggle="collapse"
                          data-target="#J_Setting_Styles"
                        >
                          <h4 class="panel-title">Styles</h4>
                        </div>
                        <div
                          id="J_Setting_Styles"
                          class="panel-collapse collapse"
                        >
                          <ul
                            class="list-group"
                            v-kb-sortable="bindingPanel.styleList"
                          >
                            <li
                              v-for="(item,index) in bindingPanel.styleList"
                              :key="index"
                              class="list-group-item"
                              :class="item.selected?'list-group-item bg-gray':'list-group-item'"
                            >
                              <span class="sortable"
                                ><i class="glyphicon glyphicon-list"></i
                              ></span>
                              <a
                                class="btn gray btn-xs pull-right margin-right-5"
                                href="javascript:;"
                                title="Remove"
                                v-kb-tooltip:top="Kooboo.text.common.remove"
                                @click="removeStyle(item)"
                                ><i class="fa fa-minus"></i
                              ></a>
                              <a
                                v-if="item.text"
                                class="btn blue btn-xs pull-right"
                                href="javascript:;"
                                title="Edit"
                                v-kb-tooltip:top="Kooboo.text.common.edit"
                                @click="editJsCss(item)"
                                ><i class="fa fa-pencil"></i
                              ></a>
                              <span class="nowrap-text">{{item.name}}</span>
                            </li>
                          </ul>
                          <div class="panel-body">
                            <button
                              type="button"
                              class="btn blue btn-xs pull-right"
                              @click="createStyle"
                              ><i class="fa fa-plus"></i
                            ></button>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div>
                      <div class="panel panel-default">
                        <div
                          class="panel-heading clickable"
                          data-toggle="collapse"
                          data-target="#J_Setting_Scripts"
                        >
                          <h4 class="panel-title">Scripts</h4>
                        </div>
                        <div
                          id="J_Setting_Scripts"
                          class="panel-collapse collapse"
                        >
                          <div class="panel-body">
                            <strong>Head</strong>
                          </div>
                          <ul
                            class="list-group"
                            id="head-scripts"
                            v-kb-sortable="bindingPanel.headScriptList"
                            style="min-height: 40px;"
                            connect="#body-scripts"
                          >
                            <li
                              class="list-group-item"
                              v-for="(item,index) in bindingPanel.headScriptList"
                              :class="{'bg-gray':item.selected}"
                            >
                              <span class="sortable"
                                ><i class="glyphicon glyphicon-list"></i
                              ></span>
                              <a
                                class="btn gray btn-xs pull-right margin-right-5"
                                href="javascript:;"
                                title="Remove"
                                v-kb-tooltip:top="Kooboo.text.common.remove"
                                @click="removeScript(item)"
                                ><i class="fa fa-minus"></i
                              ></a>
                              <a
                                v-if="item.text"
                                class="btn blue btn-xs pull-right"
                                href="javascript:;"
                                title="Edit"
                                v-kb-tooltip:top="Kooboo.text.common.edit"
                                @click="editJsCss"
                                ><i class="fa fa-pencil"></i
                              ></a>
                              <span class="nowrap-text">{{item.name}}</span>
                            </li>
                          </ul>
                          <div class="panel-body">
                            <button
                              type="button"
                              class="btn blue btn-xs pull-right"
                              @click="createScript(true)"
                              ><i class="fa fa-plus"></i
                            ></button>
                          </div>
                          <div class="panel-body">
                            <strong>Body</strong>
                          </div>
                          <ul
                            class="list-group"
                            id="body-scripts"
                            v-kb-sortable="bindingPanel.bodyScriptList"
                            connect="#head-scripts"
                            style="min-height: 40px;"
                          >
                            <li
                              class="list-group-item"
                              v-for="(item,index) in bindingPanel.bodyScriptList"
                              :class="{'bg-gray':selected}"
                            >
                              <span class="sortable"
                                ><i class="glyphicon glyphicon-list"></i
                              ></span>
                              <a
                                class="btn gray btn-xs pull-right margin-right-5"
                                href="javascript:;"
                                title="Remove"
                                v-tooltip:top="Kooboo.text.common.remove"
                                @click="removeScript"
                                ><i class="fa fa-minus"></i
                              ></a>
                              <a
                                v-if="item.text"
                                class="btn blue btn-xs pull-right"
                                href="javascript:;"
                                title="Edit"
                                v-tooltip:top="Kooboo.text.common.edit"
                                @click="editJsCss"
                                ><i class="fa fa-pencil"></i
                              ></a>
                              <span class="nowrap-text">{{item.name}}</span>
                            </li>
                          </ul>
                          <div class="panel-body">
                            <button
                              type="button"
                              class="btn blue btn-xs pull-right"
                              @click="createScript(false)"
                              ><i class="fa fa-plus"></i
                            ></button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </section>
              </div>
            </div>
          </section>
          <section class="tab-pane" :class="{active: curType == 'code'}">
            <kb-code-editor :code.sync="pageContent"></kb-code-editor>
          </section>
        </div>
        <ul class="nav nav-tabs">
          <li
            :class="{active: curType == 'preview'}"
            @click="changeType('preview')"
          >
            <a href="javascript:;">Preview</a>
          </li>
          <li :class="{active: curType == 'code'}" @click="changeType('code')">
            <a href="javascript:;">Source code</a>
          </li>
        </ul>
      </div>
    </div>
  </div>
  <div class="page-buttons">
    <div class="btn-group dropup">
      <button class="btn green" style="margin: 0;" @click="onSaveAndReturn"
        >Save &amp; Return</button
      >
      <a
        class="btn green dropdown-toggle"
        data-toggle="dropdown"
        style="margin:0;min-width:auto;"
      >
        <i class="fa fa-angle-up"></i>
      </a>
      <ul class="dropdown-menu" role="menu">
        <li><a href="javascript:;" @click="onSave">Save</a></li>
      </ul>
    </div>
    <a href="javascript:;" @click="userCancel" class="btn gray">Cancel</a>
  </div>
  <kb-page-widget-meta
    v-if="multiLangs"
    :multi-langs="multiLangs"
  ></kb-page-widget-meta>
  <kb-layout-style-script></kb-layout-style-script>
</div>

<script>
  Kooboo.pageEditor = {
    component: {},
    store: {},
    util: {},
    viewModel: {},
    widget: {}
  };
  window.__pageEditor = {};
</script>
<script>
  (function() {
    Kooboo.loadJS([
      "/_Admin/Scripts/vue-components/kb-code-editor.js",
      "/_Admin/Scripts/kooboo/Guid.js",
      "/_Admin/Scripts/lib/jquery-ui-customized.js",
      "/_Admin/Scripts/kobindings.sortable.js",
    //   "/_Admin/Scripts/lib/codemirror/lib/codemirror.js",
    //   "/_Admin/Scripts/lib/codemirror/mode/htmlmixed/htmlmixed.js",
    //   "/_Admin/Scripts/lib/codemirror/mode/javascript/javascript.js",
    //   "/_Admin/Scripts/lib/codemirror/mode/xml/xml.js",
    //   "/_Admin/Scripts/lib/codemirror/mode/css/css.js",
    //   "/_Admin/Scripts/kobindings.codemirror.js",
    //   "/_Admin/Scripts/lib/js-beautify/lib/beautify-html.js",
      "/_Admin/Scripts/lib/jquery.textarea_autosize.min.js",
      "/_Admin/Scripts/lib/bootstrap3-typeahead.min.js",
      "/_Admin/Scripts/vue-components/kbTypeahead.js",
      "/_Admin/Scripts/lib/x-editable/bootstrap-editable.min.js",
      "/_Admin/Scripts/kobindings.editable.js",
      "/_Admin/Scripts/vue-components/kbMultilangSelector.js",
      "/_Admin/Scripts/layoutEditor/viewModel/Position.js",
      "/_Admin/Scripts/layoutEditor/viewModel/Label.js",
      "/_Admin/Scripts/layoutEditor/viewModel/Script.js",
      "/_Admin/Scripts/layoutEditor/viewModel/Style.js",
      "/_Admin/Scripts/pageEditor/stores/ComponentStore.js",
      "/_Admin/Scripts/layoutEditor/stores/PositionStore.js",
      "/_Admin/Scripts/layoutEditor/stores/BindingStore.js",
      "/_Admin/Scripts/layoutEditor/viewModel/BindingPanel.js",
      "/_Admin/Scripts/pageEditor/components/basic-settings.js",
      "/_Admin/Scripts/pageEditor/components/htmlmeta.js",
      "/_Admin/Scripts/pageEditor/components/parameters.js",
      "/_Admin/Scripts/pageEditor/widgets/html-meta.js",
      "/_Admin/Scripts/layoutEditor/components/style-script.js",
      "/_Admin/Scripts/layoutEditor/components/KBFrame.js"
    ]);
    Kooboo.loadCSS([
    //   "/_Admin/Scripts/lib/codemirror/lib/codemirror.css",
      "/_Admin/Styles/bootstrap-editable/css/bootstrap-editable.css"
    ]);
  })();

  (function() {
    var Guid = Kooboo.Guid,
      BindingStore = Kooboo.pageEditor.store.BindingStore,
      BindingPanel = Kooboo.pageEditor.viewModel.BindingPanel,
      KBFrame = Kooboo.pageEditor.component.KBFrame;

    var self = new Vue({
      el: "#main",
      data: function() {
        return {
          isNewPage: false,
          pageId: Kooboo.getQueryString("Id") || Guid.Empty,
          name: "",
          bindingPanel: new BindingPanel(),
          multiLangs: null,
          pageContent: "",
          ___pageContent: "",
          cm: null,
          kbFrame: null,
          curType: "preview",
          settings: null,
          isBodyChanged: false
        };
      },
      mounted: function() {
        var self = this;
        self.isNewPage = !!self.pageId;
        self.kbFrame = new KBFrame(document.getElementById("page_iframe"), {
          type: "normal_page"
        });
        window.__pageEditor.kbFrame = self.kbFrame;
        $.when(
          Kooboo.Page.getEdit({
            Id: self.pageId
          }),
          Kooboo.Site.Langs(),
          Kooboo.Style.getExternalList(),
          Kooboo.Script.getExternalList(),
          Kooboo.ResourceGroup.Style(),
          Kooboo.ResourceGroup.Script()
        ).then(function(page, langs, styles, scripts, styleGroup, scriptGroup) {
          var styleList = [],
            styleGroupList = [],
            scriptList = [],
            scriptGroupList = [];

          page = $.isArray(page) ? page[0] : page;
          styles = $.isArray(styles) ? styles[0] : styles;
          scripts = $.isArray(scripts) ? scripts[0] : scripts;
          styleGroup = $.isArray(styleGroup) ? styleGroup[0] : styleGroup;
          scriptGroup = $.isArray(scriptGroup) ? scriptGroup[0] : scriptGroup;

          styles.model.forEach(function(style) {
            styleList.push({
              id: style.id,
              text: style.name,
              url: style.routeName
            });
          });

          scripts.model.forEach(function(script) {
            scriptList.push({
              id: script.id,
              text: script.name,
              url: script.routeName
            });
          });

          styleGroup.model.forEach(function(style) {
            styleGroupList.push({
              id: style.id,
              text: style.name,
              url: style.relativeUrl
            });
          });

          scriptGroup.model.forEach(function(script) {
            scriptGroupList.push({
              id: script.id,
              text: script.name,
              url: script.relativeUrl
            });
          });

          self.bindingPanel.styleResource = {
            styles: styleList,
            styleGroup: styleGroupList
          };

          self.bindingPanel.scriptResource = {
            scripts: scriptList,
            scriptGroup: scriptGroupList
          };

          self.multiLangs = langs[0].model;
          self.pageContent = page.model.body || "";
          self.__pageContent = self.pageContent;
          self.setHTML(self.pageContent, function() {
            self.name = page.model.name;
            self.settings = page.model;
            // self.cm = $(".CodeMirror")[0].CodeMirror;
          });
        });
      },
      methods: {
        onSaveAndReturn: function() {},
        onSave: function() {},
        setHTML: function(html, callback) {
          BindingStore.clear();
          !self.kbFrame.hasResource() &&
            self.kbFrame.setResource(self.bindingPanel.resources);
          self.kbFrame.setContent(html, function() {
            self.bindingPanel.elem = self.kbFrame.getDocumentElement();
            if (callback) callback();
          });
        },
        userCancel: function() {},
        changeType: function(type) {
          if (self.curType !== type) {
            if (type == "code") {
              self.curType = type;
              //   self.pageContent = self.getHTML();
              self._pageContent = self.pageContent;
              //   cm.refresh();
            } else {
              if (self.__pageContent !== self.pageContent) {
                self.isBodyChanged = true;
                // self.setHTML(self.pageContent, function() {
                //   Kooboo.EventBus.publish(
                //     "kb/page/title/set",
                //     kbFrame.getTitle()
                //   );
                // });
              }
              self.curType = type;
            }
          }
        },
        formatCode: function() {},
        removeStyle: function() {},
        editJsCss: function() {},
        removeScript: function() {},
        createStyle: function() {
          self.bindingPanel.createStyle();
        },
        createScript: function(b) {
          self.bindingPanel.createScript(b);
        }
      },
      watch: {
        name: function(name) {
          if (!name) return;
          Kooboo.EventBus.publish("kb/page/url/route/set", name);
        }
      }
    });
  })();
</script>
